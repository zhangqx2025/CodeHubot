# AIOT 物联网管理系统 Nginx 配置（宝塔面板版）
# 适用于 Vue3 单页应用 + FastAPI 后端
# 
# 使用说明：
# 1. 将 server_name 改为你的实际域名
# 2. 将 root 路径改为你的前端文件实际路径
# 3. 将 SSL 证书路径改为你的实际证书路径
# 4. 将日志路径改为你的实际日志路径

server
{
    listen 80;
    listen 443 ssl;
    listen 443 quic;
    http2 on;
    server_name your-domain.com;  # ⚠️ 修改为你的实际域名
    index index.php index.html index.htm default.php default.htm default.html;
    root /www/wwwroot/your-domain.com/dist;  # ⚠️ 修改为你的前端文件实际路径
    
    #CERT-APPLY-CHECK--START
    # 用于SSL证书申请时的文件验证相关配置 -- 请勿删除
    # ⚠️ 将 your-domain.com 替换为你的实际域名
    include /www/server/panel/vhost/nginx/well-known/your-domain.com.conf;
    #CERT-APPLY-CHECK--END
    
    # 扩展配置目录（宝塔面板自动生成）
    # ⚠️ 将 your-domain.com 替换为你的实际域名
    include /www/server/panel/vhost/nginx/extension/your-domain.com/*.conf;
    
    #SSL-START SSL相关配置，请勿删除或修改下一行带注释的404规则
    #error_page 404/404.html;
    # ⚠️ 将证书路径改为你的实际证书路径
    ssl_certificate    /www/server/panel/vhost/cert/your-domain.com/fullchain.pem;
    ssl_certificate_key    /www/server/panel/vhost/cert/your-domain.com/privkey.pem;
    ssl_protocols TLSv1.1 TLSv1.2 TLSv1.3;
    ssl_ciphers EECDH+CHACHA20:EECDH+CHACHA20-draft:EECDH+AES128:RSA+AES128:EECDH+AES256:RSA+AES256:EECDH+3DES:RSA+3DES:!MD5;
    ssl_prefer_server_ciphers on;
    ssl_session_tickets on;
    ssl_session_cache shared:SSL:10m;
    ssl_session_timeout 10m;
    add_header Strict-Transport-Security "max-age=31536000";
    add_header Alt-Svc 'quic=":443"; h3=":443"; h3-29=":443"; h3-27=":443";h3-25=":443"; h3-T050=":443"; h3-Q050=":443";h3-Q049=":443";h3-Q048=":443"; h3-Q046=":443"; h3-Q043=":443"';
    error_page 497  https://$host$request_uri;
    #SSL-END
    
    #ERROR-PAGE-START  错误页配置，可以注释、删除或修改
    error_page 404 /404.html;
    #error_page 502 /502.html;
    #ERROR-PAGE-END
    
    #PHP-INFO-START  PHP引用配置，可以注释或修改
    # include enable-php-00.conf;  # Vue 单页应用不需要 PHP
    #PHP-INFO-END
    
    #REWRITE-START URL重写规则引用,修改后将导致面板设置的伪静态规则失效
    # include /www/server/panel/vhost/rewrite/your-domain.com.conf;  # Vue 使用自己的路由
    #REWRITE-END
    
    # 客户端上传大小限制（用于固件上传等）
    client_max_body_size 50M;
    
    # Gzip 压缩
    gzip on;
    gzip_vary on;
    gzip_min_length 1024;
    gzip_types text/plain text/css text/xml text/javascript 
               application/x-javascript application/xml+rss 
               application/javascript application/json;
    
    #禁止访问的文件或目录
    location ~ ^/(\.user.ini|\.htaccess|\.git|\.env|\.svn|\.project|LICENSE|README.md)
    {
        return 404;
    }
    
    #一键申请SSL证书验证目录相关设置
    location ~ \.well-known{
        allow all;
    }
    
    #禁止在证书验证目录放入敏感文件
    if ( $uri ~ "^/\.well-known/.*\.(php|jsp|py|js|css|lua|ts|go|zip|tar\.gz|rar|7z|sql|bak)$" ) {
        return 403;
    }
    
    # 后端 API 代理（优先级最高，放在前面）
    location /api {
        # 代理到 FastAPI 后端
        proxy_pass http://127.0.0.1:8000;
        
        # 请求头设置
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        
        # 超时设置
        proxy_connect_timeout 60s;
        proxy_send_timeout 60s;
        proxy_read_timeout 60s;
        
        # WebSocket 支持（如果需要）
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection "upgrade";
        
        # 禁用缓存 API 响应
        add_header Cache-Control "no-cache, no-store, must-revalidate";
    }
    
    # 静态资源缓存（JS/CSS/图片等）
    location ~* \.(js|css|png|jpg|jpeg|gif|ico|svg|woff|woff2|ttf|eot)$ {
        expires 7d;
        add_header Cache-Control "public, immutable";
    }
    
    # index.html 不缓存，确保更新后能立即生效
    location = /index.html {
        add_header Cache-Control "no-cache, no-store, must-revalidate";
        add_header Pragma "no-cache";
        add_header Expires "0";
    }
    
    # 健康检查端点
    location /health {
        access_log off;
        return 200 "healthy\n";
        add_header Content-Type text/plain;
    }
    
    # Vue Router history 模式支持（必须放在最后）
    location / {
        # 解决 Vue Router history 模式刷新 404 问题
        # 所有不存在的文件请求都返回 index.html
        try_files $uri $uri/ /index.html;
    }
    
    # ⚠️ 将日志路径改为你的实际日志路径
    access_log  /www/wwwlogs/your-domain.com.log;
    error_log  /www/wwwlogs/your-domain.com.error.log;
}
