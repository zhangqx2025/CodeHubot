# åç«¯æ¨¡å‹ä¸æ•°æ®åº“åŒæ­¥åˆ†ææŠ¥å‘Š

ç”Ÿæˆæ—¶é—´ï¼š2025-11-26

## ğŸ“Š æ€»ä½“æ¦‚å†µ

æœ¬æŠ¥å‘Šè¯¦ç»†æ¯”è¾ƒäº†æ‰€æœ‰åç«¯ SQLAlchemy æ¨¡å‹ä¸ `init_database.sql` æ•°æ®åº“å®šä¹‰ä¹‹é—´çš„å·®å¼‚ã€‚

## ğŸ” å‘ç°çš„ä¸ä¸€è‡´é—®é¢˜

### 1. âœ… aiot_core_usersï¼ˆç”¨æˆ·è¡¨ï¼‰

**çŠ¶æ€ï¼šå…¼å®¹ï¼Œä½†æœ‰é¢å¤–å­—æ®µ**

| é¡¹ç›® | åç«¯æ¨¡å‹ | æ•°æ®åº“å®šä¹‰ | å»ºè®® |
|------|---------|-----------|------|
| name | âŒ ä¸å­˜åœ¨ | âœ… varchar(100) | ä¿ç•™æ•°æ®åº“å­—æ®µï¼Œæœªæ¥å¯èƒ½ä½¿ç”¨ |

**ç»“è®ºï¼š** æ•°æ®åº“å¤šäº† `name` å­—æ®µï¼Œä½†ä¸å½±å“ç°æœ‰åŠŸèƒ½ã€‚å»ºè®®ä¿ç•™è¯¥å­—æ®µä»¥å‘åå…¼å®¹ã€‚

---

### 2. âš ï¸ aiot_core_devicesï¼ˆè®¾å¤‡è¡¨ï¼‰

**çŠ¶æ€ï¼šéƒ¨åˆ†ä¸ä¸€è‡´**

| å­—æ®µ | åç«¯æ¨¡å‹ | æ•°æ®åº“å®šä¹‰ | å½±å“ | å¤„ç†æ–¹æ¡ˆ |
|------|---------|-----------|------|---------|
| device_secret | String(255) | varchar(64) | **ä¸­** | æ‰©å±•ä¸º varchar(255) |
| quality_grade | String(10) | varchar(20) | ä½ | ä¿æŒæ•°æ®åº“å®šä¹‰ |
| uptime | Integer | bigint | ä½ | ä¿æŒæ•°æ®åº“å®šä¹‰ï¼ˆbigint æ›´å®‰å…¨ï¼‰|

**å·²ä¿®å¤çš„å­—æ®µï¼ˆé€šè¿‡ 14_sync_device_fields.sqlï¼‰ï¼š**
- âœ… last_product_report, product_switch_count, auto_created_product
- âœ… group_name, room, floor
- âœ… production_date, serial_number, quality_grade
- âœ… error_count, last_error, uptime
- âœ… installation_date, warranty_expiry, last_maintenance, next_maintenance

---

### 3. âš ï¸ aiot_core_productsï¼ˆäº§å“è¡¨ï¼‰

**çŠ¶æ€ï¼šéƒ¨åˆ†ä¸ä¸€è‡´**

| å­—æ®µ | åç«¯æ¨¡å‹ | æ•°æ®åº“å®šä¹‰ | å½±å“ | å¤„ç†æ–¹æ¡ˆ |
|------|---------|-----------|------|---------|
| product_code | String(64) | varchar(50) | **é«˜** | æ‰©å±•ä¸º varchar(64) |
| sensor_types | JSON, NOT NULL | JSON, NULL | ä¸­ | è®¾ç½® NOT NULLï¼Œé»˜è®¤ {} |
| control_ports | JSON, NOT NULL | JSON, NULL | ä¸­ | è®¾ç½® NOT NULLï¼Œé»˜è®¤ {} |
| power_requirements | JSON | varchar(100) | **é«˜** | ä¿®æ”¹ä¸º JSON ç±»å‹ |

**ç»“è®ºï¼š** `product_code` å’Œ `power_requirements` å­—æ®µç±»å‹ä¸åŒ¹é…ï¼Œéœ€è¦ä¿®æ”¹ã€‚

---

### 4. âš ï¸ aiot_core_firmware_versionsï¼ˆå›ºä»¶ç‰ˆæœ¬è¡¨ï¼‰

**çŠ¶æ€ï¼šéƒ¨åˆ†ä¸ä¸€è‡´**

| å­—æ®µ | åç«¯æ¨¡å‹ | æ•°æ®åº“å®šä¹‰ | å½±å“ | å¤„ç†æ–¹æ¡ˆ |
|------|---------|-----------|------|---------|
| product_code | String(50), NOT NULL | varchar(50), NULL | ä¸­ | ä¿æŒ NULLï¼ˆé€šç”¨å›ºä»¶ï¼‰|
| file_size | Integer, NULL | int, NOT NULL | ä½ | ä¿æŒ NOT NULLï¼ˆæ•°æ®å®Œæ•´æ€§ï¼‰|
| file_hash | String(64), NULL | varchar(64), NOT NULL | ä½ | ä¿æŒ NOT NULLï¼ˆæ•°æ®å®Œæ•´æ€§ï¼‰|
| description | Text | varchar(1024) | ä½ | æ‰©å±•ä¸º text |
| release_notes | Text | varchar(1024) | ä½ | æ‰©å±•ä¸º text |

**ç»“è®ºï¼š** æ•°æ®åº“å®šä¹‰æ›´ä¸¥æ ¼ï¼Œæœ‰åŠ©äºæ•°æ®å®Œæ•´æ€§ã€‚å»ºè®®ä¿æŒæ•°æ®åº“å®šä¹‰ã€‚

---

### 5. âœ… aiot_llm_modelsï¼ˆLLMæ¨¡å‹è¡¨ï¼‰

**çŠ¶æ€ï¼šå·²åŒæ­¥ï¼ˆé€šè¿‡ 15_add_llm_penalty_fields.sqlï¼‰**

å·²æ·»åŠ çš„å­—æ®µï¼š
- âœ… frequency_penalty (decimal(3,2))
- âœ… presence_penalty (decimal(3,2))
- âœ… config (json)

---

### 6. âœ… aiot_llm_providersï¼ˆLLMæä¾›å•†è¡¨ï¼‰

**çŠ¶æ€ï¼šå·²åŒæ­¥**

æ‰€æœ‰å­—æ®µå·²æ­£ç¡®å¯¹é½ã€‚

---

### 7. âœ… aiot_agentsï¼ˆæ™ºèƒ½ä½“è¡¨ï¼‰

**çŠ¶æ€ï¼šå·²åŒæ­¥**

æ‰€æœ‰å­—æ®µå·²æ­£ç¡®å¯¹é½ï¼ŒåŒ…æ‹¬ï¼š
- âœ… llm_model_id å­—æ®µå·²å­˜åœ¨

---

### 8. âœ… aiot_pluginsï¼ˆæ’ä»¶è¡¨ï¼‰

**çŠ¶æ€ï¼šå·²åŒæ­¥**

æ‰€æœ‰å­—æ®µå·²æ­£ç¡®å¯¹é½ã€‚

---

### 9. âœ… aiot_interaction_logsï¼ˆäº¤äº’æ—¥å¿—è¡¨ï¼‰

**çŠ¶æ€ï¼šå·²åŒæ­¥ï¼ˆé€šè¿‡ 16_add_interaction_log_fields.sqlï¼‰**

å·²æ·»åŠ çš„å­—æ®µï¼š
- âœ… user_agent (text)
- âœ… session_id (varchar(100))

---

### 10. âœ… aiot_device_binding_historyï¼ˆè®¾å¤‡ç»‘å®šå†å²è¡¨ï¼‰

**çŠ¶æ€ï¼šå·²åŒæ­¥**

æ‰€æœ‰å­—æ®µå·²æ­£ç¡®å¯¹é½ã€‚

---

## ğŸ“‹ éœ€è¦æ‰§è¡Œçš„æ›´æ–°è„šæœ¬

æŒ‰ä»¥ä¸‹é¡ºåºæ‰§è¡Œï¼š

```bash
# 1. åŒæ­¥è®¾å¤‡è¡¨å­—æ®µï¼ˆå¦‚æœå°šæœªæ‰§è¡Œï¼‰
mysql -u your_user -p aiot_db < SQL/update/14_sync_device_fields.sql

# 2. æ·»åŠ  LLM æ¨¡å‹è¡¨å­—æ®µï¼ˆå¦‚æœå°šæœªæ‰§è¡Œï¼‰
mysql -u your_user -p aiot_db < SQL/update/15_add_llm_penalty_fields.sql

# 3. æ·»åŠ äº¤äº’æ—¥å¿—è¡¨å­—æ®µï¼ˆå¦‚æœå°šæœªæ‰§è¡Œï¼‰
mysql -u your_user -p aiot_db < SQL/update/16_add_interaction_log_fields.sql

# 4. å…¨é¢åŒæ­¥æ‰€æœ‰æ¨¡å‹ï¼ˆæ–°å¢ï¼‰
mysql -u your_user -p aiot_db < SQL/update/17_sync_all_models_comprehensive.sql
```

## ğŸ¯ å…³é”®ä¿®æ”¹æ€»ç»“

### é«˜ä¼˜å…ˆçº§ï¼ˆå¿…é¡»ä¿®å¤ï¼‰
1. âœ… **è®¾å¤‡è¡¨ç¼ºå¤±å­—æ®µ** - å·²é€šè¿‡è„šæœ¬ 14 ä¿®å¤
2. âœ… **LLMæ¨¡å‹è¡¨ç¼ºå¤±å­—æ®µ** - å·²é€šè¿‡è„šæœ¬ 15 ä¿®å¤
3. âœ… **äº¤äº’æ—¥å¿—è¡¨ç¼ºå¤±å­—æ®µ** - å·²é€šè¿‡è„šæœ¬ 16 ä¿®å¤
4. ğŸ”„ **äº§å“è¡¨å­—æ®µç±»å‹** - é€šè¿‡è„šæœ¬ 17 ä¿®å¤
5. ğŸ”„ **è®¾å¤‡å¯†é’¥å­—æ®µé•¿åº¦** - é€šè¿‡è„šæœ¬ 17 ä¿®å¤

### ä¸­ä¼˜å…ˆçº§ï¼ˆå»ºè®®ä¿®å¤ï¼‰
1. ğŸ”„ äº§å“è¡¨ sensor_types/control_ports çš„ NULL çº¦æŸ
2. ğŸ”„ å›ºä»¶è¡¨ description/release_notes å­—æ®µç±»å‹

### ä½ä¼˜å…ˆçº§ï¼ˆå¯é€‰ï¼‰
1. â„¹ï¸ ç”¨æˆ·è¡¨çš„ name å­—æ®µï¼ˆæ•°æ®åº“æœ‰ï¼Œæ¨¡å‹æ— ï¼‰
2. â„¹ï¸ è®¾å¤‡è¡¨çš„ quality_grade å­—æ®µé•¿åº¦å·®å¼‚
3. â„¹ï¸ è®¾å¤‡è¡¨çš„ uptime å­—æ®µç±»å‹å·®å¼‚

## âœ… æ‰§è¡Œæ£€æŸ¥æ¸…å•

- [ ] å¤‡ä»½ç”Ÿäº§æ•°æ®åº“
- [ ] åœ¨æµ‹è¯•ç¯å¢ƒéªŒè¯è„šæœ¬
- [ ] æŒ‰é¡ºåºæ‰§è¡Œ 4 ä¸ªæ›´æ–°è„šæœ¬
- [ ] æ£€æŸ¥è„šæœ¬æ‰§è¡Œç»“æœ
- [ ] é‡å¯åç«¯æœåŠ¡
- [ ] éªŒè¯ç³»ç»ŸåŠŸèƒ½æ­£å¸¸
- [ ] æäº¤å˜æ›´åˆ° Git ä»“åº“

## ğŸ“ æ³¨æ„äº‹é¡¹

1. **æ•°æ®å¤‡ä»½**ï¼šæ‰§è¡Œå‰åŠ¡å¿…å¤‡ä»½æ•°æ®åº“
2. **è„šæœ¬é¡ºåº**ï¼šå¿…é¡»æŒ‰ç¼–å·é¡ºåºæ‰§è¡Œï¼ˆ14 â†’ 15 â†’ 16 â†’ 17ï¼‰
3. **æµ‹è¯•éªŒè¯**ï¼šå»ºè®®å…ˆåœ¨æµ‹è¯•ç¯å¢ƒæ‰§è¡Œ
4. **æœåŠ¡é‡å¯**ï¼šå…¨éƒ¨æ‰§è¡Œå®Œæˆåé‡å¯åç«¯æœåŠ¡
5. **å…¼å®¹æ€§**ï¼šæ‰€æœ‰ä¿®æ”¹éƒ½å‘åå…¼å®¹ï¼Œä¸ä¼šä¸¢å¤±ç°æœ‰æ•°æ®

## ğŸ”„ åç»­å»ºè®®

1. **æ¨¡å‹å­—æ®µå¯¹é½**ï¼šå»ºè®®åç«¯æ¨¡å‹ä¸­æ·»åŠ  `name` å­—æ®µåˆ° `User` æ¨¡å‹
2. **å­—æ®µç±»å‹ç»Ÿä¸€**ï¼šå»ºè®®ç»Ÿä¸€æ—¥æœŸæ—¶é—´å­—æ®µçš„ç±»å‹ï¼ˆDateTime vs Dateï¼‰
3. **å®šæœŸæ£€æŸ¥**ï¼šå»ºç«‹å®šæœŸæ£€æŸ¥æœºåˆ¶ï¼Œç¡®ä¿æ¨¡å‹ä¸æ•°æ®åº“å®šä¹‰ä¿æŒåŒæ­¥
4. **æ–‡æ¡£ç»´æŠ¤**ï¼šæ›´æ–° ORM æ¨¡å‹æ—¶åŒæ­¥æ›´æ–° SQL è„šæœ¬
5. **è‡ªåŠ¨åŒ–å·¥å…·**ï¼šè€ƒè™‘ä½¿ç”¨ Alembic ç­‰è¿ç§»å·¥å…·è¿›è¡Œç‰ˆæœ¬ç®¡ç†

---

**æŠ¥å‘Šç”Ÿæˆå®Œæ¯•** ğŸ‰

