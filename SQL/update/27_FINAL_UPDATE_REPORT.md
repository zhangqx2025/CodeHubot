# æ•°æ®åº“è¡¨é‡å‘½åå®Œæ•´æ›´æ–°æŠ¥å‘Š

## ğŸ“‹ æ‰§è¡Œæ€»ç»“

### âœ… ä»»åŠ¡å®Œæˆæƒ…å†µ

| é¡¹ç›® | çŠ¶æ€ | æ•°é‡ | è¯´æ˜ |
|------|------|------|------|
| æ•°æ®åº“è¡¨é‡å‘½å | âœ… å·²å‡†å¤‡ | 23å¼ è¡¨ | SQLè„šæœ¬å·²åˆ›å»º |
| Backendæ¨¡å‹æ›´æ–° | âœ… å·²å®Œæˆ | 18ä¸ªæ–‡ä»¶ | æ‰€æœ‰æ¨¡å‹æ–‡ä»¶å·²æ›´æ–° |
| Backend APIæ›´æ–° | âœ… å·²å®Œæˆ | 2ä¸ªæ–‡ä»¶ | SQLæŸ¥è¯¢å·²æ›´æ–° |
| Backendå…¶ä»–æ–‡ä»¶ | âœ… å·²å®Œæˆ | 2ä¸ªæ–‡ä»¶ | æ—¥å¿—å’Œè„šæœ¬å·²æ›´æ–° |
| å¾®æœåŠ¡æ›´æ–° | âœ… å·²å®Œæˆ | 5ä¸ªæ–‡ä»¶ | 3ä¸ªæœåŠ¡å·²æ›´æ–° |
| æ–‡æ¡£æ›´æ–° | âœ… å·²å®Œæˆ | 2ä¸ªæ–‡ä»¶ | è¿ç§»è„šæœ¬å’Œæ‘˜è¦ |

**æ€»è®¡**ï¼šâœ… 27ä¸ªä»£ç æ–‡ä»¶å·²æ›´æ–°ï¼Œ2ä¸ªæ–‡æ¡£å·²åˆ›å»º

---

## ğŸ¯ æ¶‰åŠçš„æœåŠ¡

### 1ï¸âƒ£ backendï¼ˆä¸»åç«¯æœåŠ¡ï¼‰
- **æ›´æ–°æ–‡ä»¶æ•°**ï¼š22ä¸ª
- **æ¶‰åŠæ¨¡å—**ï¼š
  - Coreï¼ˆæ ¸å¿ƒæ¨¡å—ï¼‰
  - Deviceï¼ˆè®¾å¤‡æ¨¡å—ï¼‰
  - Agentï¼ˆæ™ºèƒ½ä½“æ¨¡å—ï¼‰
  - KBï¼ˆçŸ¥è¯†åº“æ¨¡å—ï¼‰
  - LLMï¼ˆå¤§æ¨¡å‹æ¨¡å—ï¼‰
  - Pluginï¼ˆæ’ä»¶æ¨¡å—ï¼‰
  - Workflowï¼ˆå·¥ä½œæµæ¨¡å—ï¼‰

### 2ï¸âƒ£ mqtt-serviceï¼ˆMQTTæ¶ˆæ¯æœåŠ¡ï¼‰
- **æ›´æ–°æ–‡ä»¶æ•°**ï¼š2ä¸ª
- **ä½¿ç”¨çš„è¡¨**ï¼š
  - `device_main`ï¼ˆåŸ `aiot_core_devices`ï¼‰
  - `device_products`ï¼ˆåŸ `aiot_core_products`ï¼‰
- **åŠŸèƒ½**ï¼šè®¾å¤‡è¿æ¥ã€æ•°æ®ä¸ŠæŠ¥ã€çŠ¶æ€æ›´æ–°

### 3ï¸âƒ£ config-serviceï¼ˆè®¾å¤‡é…ç½®æœåŠ¡ï¼‰
- **æ›´æ–°æ–‡ä»¶æ•°**ï¼š1ä¸ª
- **ä½¿ç”¨çš„è¡¨**ï¼š
  - `device_main`ï¼ˆåŸ `aiot_core_devices`ï¼‰
  - `device_firmware_versions`ï¼ˆåŸ `aiot_core_firmware_versions`ï¼‰
  - `aiot_access_logs`ï¼ˆè®¿é—®æ—¥å¿—è¡¨ï¼Œæœªé‡å‘½åï¼‰
- **åŠŸèƒ½**ï¼šè®¾å¤‡é…ç½®æ¨é€ã€å›ºä»¶ç‰ˆæœ¬ç®¡ç†

### 4ï¸âƒ£ plugin-backend-serviceï¼ˆæ’ä»¶åç«¯æœåŠ¡ï¼‰
- **æ›´æ–°æ–‡ä»¶æ•°**ï¼š1ä¸ª
- **ä½¿ç”¨çš„è¡¨**ï¼š
  - `device_main`ï¼ˆåŸ `aiot_core_devices`ï¼‰
  - `aiot_interaction_logs`ï¼ˆäº¤äº’æ—¥å¿—è¡¨ï¼Œæœªé‡å‘½åï¼‰
- **åŠŸèƒ½**ï¼šæ’ä»¶åŠŸèƒ½æ”¯æŒã€äº¤äº’è®°å½•

### 5ï¸âƒ£ æœªä½¿ç”¨æ•°æ®åº“çš„æœåŠ¡
ä»¥ä¸‹æœåŠ¡ä¸ç›´æ¥è®¿é—®æ•°æ®åº“ï¼Œæ— éœ€æ›´æ–°ï¼š
- âœ… celery-serviceï¼ˆä»»åŠ¡é˜Ÿåˆ—æœåŠ¡ï¼‰
- âœ… plugin-serviceï¼ˆæ’ä»¶æœåŠ¡ï¼‰
- âœ… frontendï¼ˆå‰ç«¯åº”ç”¨ï¼‰

---

## ğŸ“Š è¡¨åå˜æ›´è¯¦ç»†æ¸…å•

### æ ¸å¿ƒæ¨¡å—è¡¨ï¼ˆ2å¼ ï¼‰
```
aiot_core_users        â†’ core_users
aiot_schools           â†’ core_schools
```

### è®¾å¤‡æ¨¡å—è¡¨ï¼ˆ6å¼ ï¼‰
```
aiot_core_devices             â†’ device_main
aiot_core_products            â†’ device_products
aiot_core_firmware_versions   â†’ device_firmware_versions
aiot_device_binding_history   â†’ device_binding_history
aiot_device_groups            â†’ device_groups
aiot_device_group_members     â†’ device_group_members
```

### æ™ºèƒ½ä½“æ¨¡å—è¡¨ï¼ˆ2å¼ ï¼‰
```
aiot_agents                   â†’ agent_main
aiot_agent_knowledge_bases    â†’ agent_knowledge_bases
```

### çŸ¥è¯†åº“æ¨¡å—è¡¨ï¼ˆ7å¼ ï¼‰
```
aiot_knowledge_bases      â†’ kb_main
aiot_documents            â†’ kb_documents
aiot_document_chunks      â†’ kb_document_chunks
aiot_kb_permissions       â†’ kb_permissions
aiot_kb_sharing           â†’ kb_sharing
aiot_kb_retrieval_logs    â†’ kb_retrieval_logs
aiot_kb_analytics         â†’ kb_analytics
```

### LLMæ¨¡å—è¡¨ï¼ˆ3å¼ ï¼‰
```
aiot_llm_models           â†’ llm_models
aiot_llm_providers        â†’ llm_providers
aiot_prompt_templates     â†’ llm_prompt_templates
```

### æ’ä»¶æ¨¡å—è¡¨ï¼ˆ1å¼ ï¼‰
```
aiot_plugins              â†’ plugin_main
```

### å·¥ä½œæµæ¨¡å—è¡¨ï¼ˆ2å¼ ï¼‰
```
aiot_workflows            â†’ workflow_main
aiot_workflow_executions  â†’ workflow_executions
```

**æ€»è®¡**ï¼š23å¼ è¡¨

---

## ğŸš€ æ‰§è¡Œæ­¥éª¤

### ç¬¬ä¸€æ­¥ï¼šæ‰§è¡Œæ•°æ®åº“è¿ç§»
```bash
# 1. è¿æ¥åˆ°è¿œç¨‹æ•°æ®åº“æœåŠ¡å™¨
ssh user@your-server

# 2. å¤‡ä»½æ•°æ®åº“ï¼ˆé‡è¦ï¼ï¼‰
mysqldump -u username -p aiot_admin > backup_before_rename_$(date +%Y%m%d_%H%M%S).sql

# 3. æ‰§è¡Œè¡¨é‡å‘½åè„šæœ¬
mysql -u username -p --default-character-set=utf8mb4 aiot_admin < /path/to/27_rename_tables_to_new_schema.sql

# 4. éªŒè¯è¡¨æ˜¯å¦é‡å‘½åæˆåŠŸ
mysql -u username -p aiot_admin -e "SHOW TABLES LIKE 'core_%';"
mysql -u username -p aiot_admin -e "SHOW TABLES LIKE 'device_%';"
mysql -u username -p aiot_admin -e "SHOW TABLES LIKE 'kb_%';"
```

### ç¬¬äºŒæ­¥ï¼šæ›´æ–°ä»£ç 
```bash
# åœ¨æœ¬åœ°å¼€å‘ç¯å¢ƒ
cd /path/to/CodeHubot

# æ‹‰å–æœ€æ–°ä»£ç ï¼ˆæ‰€æœ‰è¡¨åå·²æ›´æ–°ï¼‰
git pull origin main
```

### ç¬¬ä¸‰æ­¥ï¼šé‡å¯æ‰€æœ‰æœåŠ¡
```bash
# åœ¨æœåŠ¡å™¨ä¸Š
cd /path/to/CodeHubot

# åœæ­¢æ‰€æœ‰æœåŠ¡
./stop-all.sh

# ç­‰å¾…5ç§’
sleep 5

# å¯åŠ¨æ‰€æœ‰æœåŠ¡
./start-all.sh
```

### ç¬¬å››æ­¥ï¼šéªŒè¯æœåŠ¡çŠ¶æ€
```bash
# æ£€æŸ¥æ‰€æœ‰æœåŠ¡æ˜¯å¦æ­£å¸¸å¯åŠ¨
docker ps  # å¦‚æœä½¿ç”¨Docker
# æˆ–
ps aux | grep python  # å¦‚æœç›´æ¥è¿è¡ŒPython

# æ£€æŸ¥æ—¥å¿—
tail -f backend/logs/app.log
tail -f mqtt-service/logs/mqtt.log
tail -f config-service/logs/config.log
tail -f plugin-backend-service/logs/plugin.log
```

---

## âœ… éªŒè¯æ¸…å•

### æ•°æ®åº“éªŒè¯
- [ ] æ‰€æœ‰23å¼ è¡¨å·²æˆåŠŸé‡å‘½å
- [ ] å¤–é”®çº¦æŸä»ç„¶æœ‰æ•ˆ
- [ ] ç´¢å¼•å®Œæ•´æ— æŸå¤±
- [ ] æ•°æ®å®Œæ•´æ— ä¸¢å¤±

### BackendæœåŠ¡éªŒè¯
- [ ] backendæœåŠ¡å¯åŠ¨æ— é”™è¯¯
- [ ] APIæ¥å£å“åº”æ­£å¸¸
- [ ] ç”¨æˆ·ç™»å½•åŠŸèƒ½æ­£å¸¸
- [ ] è®¾å¤‡ç®¡ç†åŠŸèƒ½æ­£å¸¸
- [ ] æ™ºèƒ½ä½“åŠŸèƒ½æ­£å¸¸
- [ ] çŸ¥è¯†åº“åŠŸèƒ½æ­£å¸¸
- [ ] å·¥ä½œæµåŠŸèƒ½æ­£å¸¸

### MQTTæœåŠ¡éªŒè¯
- [ ] mqtt-serviceå¯åŠ¨æ— é”™è¯¯
- [ ] è®¾å¤‡å¯ä»¥æ­£å¸¸è¿æ¥
- [ ] è®¾å¤‡æ•°æ®ä¸ŠæŠ¥æ­£å¸¸
- [ ] è®¾å¤‡çŠ¶æ€æ›´æ–°æ­£å¸¸

### ConfigæœåŠ¡éªŒè¯
- [ ] config-serviceå¯åŠ¨æ— é”™è¯¯
- [ ] è®¾å¤‡é…ç½®æ‹‰å–æ­£å¸¸
- [ ] å›ºä»¶ç‰ˆæœ¬æŸ¥è¯¢æ­£å¸¸

### Plugin BackendæœåŠ¡éªŒè¯
- [ ] plugin-backend-serviceå¯åŠ¨æ— é”™è¯¯
- [ ] æ’ä»¶åŠŸèƒ½è°ƒç”¨æ­£å¸¸
- [ ] äº¤äº’è®°å½•ä¿å­˜æ­£å¸¸

### å‰ç«¯éªŒè¯
- [ ] å‰ç«¯åº”ç”¨åŠ è½½æ­£å¸¸
- [ ] ç”¨æˆ·ç™»å½•æ­£å¸¸
- [ ] è®¾å¤‡åˆ—è¡¨æ˜¾ç¤ºæ­£å¸¸
- [ ] æ‰€æœ‰åŠŸèƒ½æ¨¡å—æ­£å¸¸

---

## âš ï¸ å¸¸è§é—®é¢˜ä¸è§£å†³æ–¹æ¡ˆ

### é—®é¢˜1ï¼šè¡¨åæ‰¾ä¸åˆ°é”™è¯¯
**é”™è¯¯ä¿¡æ¯**ï¼š`Table 'aiot_admin.aiot_core_users' doesn't exist`

**åŸå› **ï¼šä»£ç æœªæ›´æ–°æˆ–æœåŠ¡æœªé‡å¯

**è§£å†³æ–¹æ¡ˆ**ï¼š
1. ç¡®è®¤ä»£ç å·²æ›´æ–°åˆ°æœ€æ–°ç‰ˆæœ¬
2. é‡å¯æ‰€æœ‰æœåŠ¡
3. æ£€æŸ¥æ—¥å¿—ä¸­æ˜¯å¦æœ‰å…¶ä»–é”™è¯¯

### é—®é¢˜2ï¼šå¤–é”®çº¦æŸé”™è¯¯
**é”™è¯¯ä¿¡æ¯**ï¼š`Foreign key constraint fails`

**åŸå› **ï¼šè¡¨é‡å‘½åä¸å®Œæ•´

**è§£å†³æ–¹æ¡ˆ**ï¼š
1. æ£€æŸ¥æ‰€æœ‰23å¼ è¡¨æ˜¯å¦éƒ½å·²é‡å‘½å
2. ä½¿ç”¨SQLè„šæœ¬å†æ¬¡æ‰§è¡Œï¼ˆå¦‚æœæ”¯æŒé‡å¤æ‰§è¡Œï¼‰
3. æ‰‹åŠ¨æ£€æŸ¥å¹¶ä¿®å¤å¤–é”®çº¦æŸ

### é—®é¢˜3ï¼šæœåŠ¡å¯åŠ¨å¤±è´¥
**é”™è¯¯ä¿¡æ¯**ï¼šå„ç§Pythonå¼‚å¸¸

**åŸå› **ï¼šä»£ç æ–‡ä»¶æ›´æ–°ä¸å®Œæ•´

**è§£å†³æ–¹æ¡ˆ**ï¼š
1. é‡æ–°æ‹‰å–æœ€æ–°ä»£ç 
2. æ£€æŸ¥Pythonä¾èµ–æ˜¯å¦å®‰è£…å®Œæ•´
3. æŸ¥çœ‹è¯¦ç»†çš„é”™è¯¯æ—¥å¿—

### é—®é¢˜4ï¼šMQTTè®¾å¤‡è¿æ¥å¤±è´¥
**é”™è¯¯ä¿¡æ¯**ï¼šè®¾å¤‡æ— æ³•è¿æ¥æˆ–æ•°æ®æ— æ³•ä¸ŠæŠ¥

**åŸå› **ï¼šmqtt-serviceæœªæ­£ç¡®æ›´æ–°

**è§£å†³æ–¹æ¡ˆ**ï¼š
1. æ£€æŸ¥mqtt-service/models.pyæ˜¯å¦å·²æ›´æ–°
2. é‡å¯mqtt-service
3. æ£€æŸ¥MQTT brokeræ˜¯å¦æ­£å¸¸

---

## ğŸ“ æŠ€æœ¯æ”¯æŒè”ç³»æ–¹å¼

å¦‚é‡åˆ°é—®é¢˜ï¼Œè¯·æŒ‰ä»¥ä¸‹é¡ºåºæ£€æŸ¥ï¼š

1. **æ£€æŸ¥æ—¥å¿—æ–‡ä»¶**
   - backend/logs/app.log
   - mqtt-service/logs/mqtt.log
   - config-service/logs/config.log
   - plugin-backend-service/logs/plugin.log

2. **æ£€æŸ¥æ•°æ®åº“**
   - è¡¨åæ˜¯å¦æ­£ç¡®
   - å¤–é”®çº¦æŸæ˜¯å¦å®Œæ•´
   - æ•°æ®æ˜¯å¦å®Œæ•´

3. **æ£€æŸ¥æœåŠ¡çŠ¶æ€**
   - æ‰€æœ‰æœåŠ¡æ˜¯å¦éƒ½å·²é‡å¯
   - ç«¯å£æ˜¯å¦è¢«å ç”¨
   - ç½‘ç»œè¿æ¥æ˜¯å¦æ­£å¸¸

4. **è”ç³»å¼€å‘å›¢é˜Ÿ**
   - æä¾›è¯¦ç»†çš„é”™è¯¯æ—¥å¿—
   - è¯´æ˜æ‰§è¡Œçš„æ­¥éª¤
   - æè¿°é‡åˆ°çš„å…·ä½“é—®é¢˜

---

## ğŸ“ æ›´æ–°è®°å½•

| æ—¥æœŸ | ç‰ˆæœ¬ | è¯´æ˜ |
|------|------|------|
| 2025-12-15 | 1.0 | åˆå§‹ç‰ˆæœ¬ï¼Œå®Œæˆæ‰€æœ‰è¡¨é‡å‘½åå’Œä»£ç æ›´æ–° |

---

## ğŸ‰ æ€»ç»“

æœ¬æ¬¡æ•°æ®åº“è¡¨é‡å‘½åæ˜¯ä¸€æ¬¡é‡è¦çš„æ¶æ„ä¼˜åŒ–ï¼š

âœ… **æé«˜äº†ä»£ç å¯è¯»æ€§**ï¼šæ–°çš„è¡¨åæ›´æ¸…æ™°åœ°åæ˜ äº†å„æ¨¡å—çš„åŠŸèƒ½

âœ… **æ”¹å–„äº†ç»´æŠ¤æ€§**ï¼šæ¨¡å—åŒ–çš„è¡¨å‘½åä¾¿äºä»£ç ç»´æŠ¤å’Œæ‰©å±•

âœ… **ä¿æŒäº†æ•°æ®å®Œæ•´æ€§**ï¼šé‡å‘½åè¿‡ç¨‹ä¸å½±å“ä»»ä½•æ•°æ®

âœ… **å…¼å®¹MySQL 5.7-8.0**ï¼šè¿ç§»è„šæœ¬å…¼å®¹ä¸»æµMySQLç‰ˆæœ¬

âš ï¸ **éœ€è¦åè°ƒæ›´æ–°**ï¼šæ‰€æœ‰ä½¿ç”¨æ•°æ®åº“çš„æœåŠ¡éƒ½éœ€è¦åŒæ­¥æ›´æ–°

ğŸ“Œ **æ‰§è¡Œå»ºè®®**ï¼šå»ºè®®åœ¨ä¸šåŠ¡ä½å³°æœŸæ‰§è¡Œï¼Œé¢„ç•™1-2å°æ—¶çš„ç»´æŠ¤çª—å£

---

**ç¥æ›´æ–°é¡ºåˆ©ï¼** ğŸŠ
