# å­¦æ ¡ç”¨æˆ·æƒé™é—®é¢˜è§£å†³æ–¹æ¡ˆ

## é—®é¢˜æè¿°

è®¿é—® `pbl/school/users` æ—¶æŠ¥é”™ï¼š**"æ— æƒé™æŸ¥çœ‹å…¶ä»–å­¦æ ¡çš„æ•°æ®"**ï¼Œä½†å®é™…ä¸Šå¹¶æ²¡æœ‰è®¿é—®å…¶ä»–å­¦æ ¡ã€‚

## é—®é¢˜è¯Šæ–­

è¿è¡Œè¯Šæ–­è„šæœ¬åå‘ç°ï¼š

```bash
cd backend
python3 scripts/diagnose_school_permission.py
```

**è¯Šæ–­ç»“æœï¼š**
- âœ… é•¿æ˜¥å¸‚å®éªŒä¸­å­¦ç®¡ç†å‘˜ (admin@CC-SYZX) - school_id: 3, UUID: `ed9f6e07-8c04-42a0-aba7-52eefd6ec71d`
- âœ… é•¿æ˜¥å¸‚ç¬¬äºŒä¸­å­¦ç®¡ç†å‘˜ (admin@CC-DEZX) - school_id: 1, UUID: `a54ef548-7ff7-4358-bfbe-14d2aa93cf40`

è´¦å·é…ç½®éƒ½æ˜¯æ­£ç¡®çš„ï¼

## æ ¹æœ¬åŸå› 

**å‰ç«¯ä¼ é€’äº†é”™è¯¯çš„ `school_uuid` å‚æ•°ï¼**

ä¾‹å¦‚ï¼š
- ä½ ç”¨ `admin@CC-SYZX` ç™»å½•ï¼ˆUUIDåº”è¯¥æ˜¯ `ed9f6e07-8c04-42a0-aba7-52eefd6ec71d`ï¼‰
- ä½†å‰ç«¯è°ƒç”¨äº† `/pbl/school/a54ef548-7ff7-4358-bfbe-14d2aa93cf40/users`ï¼ˆè¿™æ˜¯å¦ä¸€ä¸ªå­¦æ ¡ï¼‰
- åŸæ¥ä¼šå¯¼è‡´æƒé™æ£€æŸ¥å¤±è´¥

## ğŸ”’ å®‰å…¨è®¾è®¡æ”¹è¿›

**æ ¸å¿ƒåŸåˆ™ï¼šå­¦æ ¡ç®¡ç†å‘˜ä¸åº”è¯¥æœ‰ä»»ä½•æœºä¼šè®¿é—®å…¶ä»–å­¦æ ¡çš„æ•°æ®**

ç°åœ¨å·²ç»å®ç°äº†**é›¶ä¿¡ä»»å®‰å…¨è®¾è®¡**ï¼š

### 1. è‡ªåŠ¨UUIDæ›¿æ¢
å³ä½¿å‰ç«¯ä¼ é€’äº†é”™è¯¯çš„UUIDï¼Œåç«¯ä¹Ÿä¼šè‡ªåŠ¨æ‹¦æˆªï¼š
- âœ… å­¦æ ¡ç®¡ç†å‘˜ä¼ å…¥ä»»ä½•UUIDï¼Œéƒ½åªè¿”å›è‡ªå·±å­¦æ ¡çš„æ•°æ®
- âœ… è®°å½•æ‰€æœ‰å¯ç–‘çš„è®¿é—®å°è¯•åˆ°æ—¥å¿—
- âœ… ä»æ ¹æœ¬ä¸Šé˜²æ­¢æ•°æ®æ³„éœ²

### 2. å¤šå±‚é˜²å¾¡
- **ç¬¬1å±‚**ï¼šå‰ç«¯ä½¿ç”¨ä¾¿æ·APIï¼Œä¸éœ€è¦ä¼ é€’UUID
- **ç¬¬2å±‚**ï¼šåç«¯è‡ªåŠ¨æ›¿æ¢UUIDï¼Œé˜²æ­¢è®¿é—®å…¶ä»–å­¦æ ¡
- **ç¬¬3å±‚**ï¼šæ—¥å¿—å®¡è®¡ï¼Œè®°å½•æ‰€æœ‰å¼‚å¸¸è®¿é—®
- **ç¬¬4å±‚**ï¼šæ•°æ®åº“å±‚é¢çš„æƒé™æ§åˆ¶

## è§£å†³æ–¹æ¡ˆ

### âœ¨ æ–¹æ¡ˆ1ï¼šä½¿ç”¨æ–°å¢çš„ä¾¿æ·APIï¼ˆå¼ºçƒˆæ¨èï¼‰

æˆ‘å·²ç»æ–°å¢äº†ä¸¤ä¸ªAPIï¼Œ**æ— éœ€ä¼ é€’ school_uuid**ï¼š

#### 1. è·å–å½“å‰å­¦æ ¡ä¿¡æ¯

```http
GET /pbl/school/my-school/info
```

**å“åº”ï¼š**
```json
{
  "code": 200,
  "data": {
    "uuid": "ed9f6e07-8c04-42a0-aba7-52eefd6ec71d",
    "school_name": "é•¿æ˜¥å¸‚å®éªŒä¸­å­¦",
    "school_code": "CC-SYZX",
    ...
  }
}
```

#### 2. è·å–å½“å‰å­¦æ ¡çš„ç”¨æˆ·åˆ—è¡¨

```http
GET /pbl/school/my-school/users?skip=0&limit=20&role=student
```

**æ”¯æŒçš„å‚æ•°ï¼š**
- `skip`: åˆ†é¡µåç§»
- `limit`: æ¯é¡µæ•°é‡
- `role`: è§’è‰²ç­›é€‰ï¼ˆ`teacher` æˆ– `student`ï¼‰
- `keyword`: å…³é”®è¯æœç´¢ï¼ˆæœç´¢å§“åã€ç”¨æˆ·åã€å·¥å·ã€å­¦å·ï¼‰

**å“åº”ï¼š**
```json
{
  "code": 200,
  "data": {
    "items": [...],
    "total": 50,
    "school_name": "é•¿æ˜¥å¸‚å®éªŒä¸­å­¦",
    "school_uuid": "ed9f6e07-8c04-42a0-aba7-52eefd6ec71d"
  }
}
```

### ğŸ”§ æ–¹æ¡ˆ2ï¼šä¿®å¤å‰ç«¯ä»£ç 

å¦‚æœå¿…é¡»ä½¿ç”¨æ—§çš„APIï¼Œéœ€è¦å…ˆè·å–æ­£ç¡®çš„UUIDï¼š

```javascript
// 1. è·å–å½“å‰å­¦æ ¡UUID
const { data } = await axios.get('/pbl/school/my-school/info');
const schoolUuid = data.data.uuid;

// 2. ä½¿ç”¨æ­£ç¡®çš„UUIDè°ƒç”¨API
const users = await axios.get(`/pbl/school/${schoolUuid}/users`);
```

## æ”¹è¿›ç‚¹

### 1. æ›´å‹å¥½çš„é”™è¯¯æç¤º

**ä¹‹å‰ï¼š**
```
æ— æƒé™æŸ¥çœ‹å…¶ä»–å­¦æ ¡ç”¨æˆ·
```

**ç°åœ¨ï¼š**
```
æ— æƒé™æŸ¥çœ‹å…¶ä»–å­¦æ ¡ç”¨æˆ·ã€‚
æ‚¨å½“å‰ç®¡ç†çš„å­¦æ ¡æ˜¯ï¼šé•¿æ˜¥å¸‚å®éªŒä¸­å­¦ï¼Œ
æ‚¨è®¿é—®çš„å­¦æ ¡æ˜¯ï¼šé•¿æ˜¥å¸‚ç¬¬äºŒä¸­å­¦ã€‚
è¯·ç¡®è®¤è®¿é—®çš„å­¦æ ¡UUIDæ­£ç¡®ã€‚
```

### 2. è¯¦ç»†çš„åç«¯æ—¥å¿—

å½“æƒé™æ£€æŸ¥å¤±è´¥æ—¶ï¼Œåç«¯ä¼šè®°å½•ï¼š
```
æƒé™æ‹’ç» - ç®¡ç†å‘˜ admin@CC-SYZX (school_id=3, å­¦æ ¡=é•¿æ˜¥å¸‚å®éªŒä¸­å­¦) 
å°è¯•è®¿é—®å…¶ä»–å­¦æ ¡ é•¿æ˜¥å¸‚ç¬¬äºŒä¸­å­¦ (id=1, uuid=xxx) çš„ç”¨æˆ·
```

## å¦‚ä½•æµ‹è¯•

### æ–¹æ³•1ï¼šä½¿ç”¨æµ‹è¯•è„šæœ¬

```bash
# é¦–å…ˆè·å–ä½ çš„ç™»å½•token
TOKEN="your_access_token_here"

# è¿è¡Œæµ‹è¯•è„šæœ¬
./backend/scripts/test_school_apis.sh $TOKEN
```

### æ–¹æ³•2ï¼šæ‰‹åŠ¨æµ‹è¯•

```bash
# è·å–å½“å‰å­¦æ ¡ä¿¡æ¯
curl -X GET "http://localhost:8000/pbl/school/my-school/info" \
  -H "Authorization: Bearer YOUR_TOKEN"

# è·å–å½“å‰å­¦æ ¡çš„ç”¨æˆ·åˆ—è¡¨
curl -X GET "http://localhost:8000/pbl/school/my-school/users?limit=10" \
  -H "Authorization: Bearer YOUR_TOKEN"
```

## å‰ç«¯é›†æˆç¤ºä¾‹

### Vue.js

```vue
<template>
  <div>
    <h2>{{ schoolInfo.school_name }} - ç”¨æˆ·ç®¡ç†</h2>
    <el-table :data="users">
      <el-table-column prop="name" label="å§“å"></el-table-column>
      <el-table-column prop="role" label="è§’è‰²"></el-table-column>
      <el-table-column prop="student_number" label="å­¦å·"></el-table-column>
    </el-table>
  </div>
</template>

<script>
export default {
  data() {
    return {
      schoolInfo: {},
      users: []
    };
  },
  async created() {
    await this.fetchSchoolInfo();
    await this.fetchUsers();
  },
  methods: {
    async fetchSchoolInfo() {
      const { data } = await this.$axios.get('/pbl/school/my-school/info');
      this.schoolInfo = data.data;
    },
    async fetchUsers(page = 1, pageSize = 20) {
      const params = {
        skip: (page - 1) * pageSize,
        limit: pageSize
      };
      const { data } = await this.$axios.get('/pbl/school/my-school/users', { params });
      this.users = data.data.items;
    }
  }
};
</script>
```

### React

```javascript
import { useState, useEffect } from 'react';
import axios from 'axios';

function SchoolUsers() {
  const [schoolInfo, setSchoolInfo] = useState(null);
  const [users, setUsers] = useState([]);
  
  useEffect(() => {
    fetchSchoolInfo();
    fetchUsers();
  }, []);
  
  const fetchSchoolInfo = async () => {
    const { data } = await axios.get('/pbl/school/my-school/info');
    setSchoolInfo(data.data);
  };
  
  const fetchUsers = async (page = 1, pageSize = 20) => {
    const { data } = await axios.get('/pbl/school/my-school/users', {
      params: {
        skip: (page - 1) * pageSize,
        limit: pageSize
      }
    });
    setUsers(data.data.items);
  };
  
  return (
    <div>
      <h2>{schoolInfo?.school_name} - ç”¨æˆ·ç®¡ç†</h2>
      {/* æ¸²æŸ“ç”¨æˆ·åˆ—è¡¨ */}
    </div>
  );
}
```

## ç›¸å…³æ–‡ä»¶

- ğŸ“„ è¯¦ç»†æ–‡æ¡£ï¼š`backend/docs/school_permission_issue_fix.md`
- ğŸ”§ APIå®ç°ï¼š`backend/app/api/pbl/schools.py`
- ğŸ” è¯Šæ–­è„šæœ¬ï¼š`backend/scripts/diagnose_school_permission.py`
- ğŸ§ª æµ‹è¯•è„šæœ¬ï¼š`backend/scripts/test_school_apis.sh`

## å¿«é€Ÿå‘½ä»¤

```bash
# è¯Šæ–­æƒé™é…ç½®
cd backend && python3 scripts/diagnose_school_permission.py

# æµ‹è¯•æ–°APIï¼ˆéœ€è¦å…ˆè·å–tokenï¼‰
./backend/scripts/test_school_apis.sh YOUR_TOKEN

# æŸ¥çœ‹APIæ—¥å¿—
tail -f backend/logs/app.log | grep "æƒé™"
```

## æ€»ç»“

âœ… **é—®é¢˜å·²è§£å†³ï¼š**
1. æ–°å¢äº†ä¸¤ä¸ªä¾¿æ·APIï¼Œæ— éœ€ä¼ é€’ `school_uuid`
2. æ”¹è¿›äº†é”™è¯¯æç¤ºä¿¡æ¯ï¼Œæ›´å®¹æ˜“å®šä½é—®é¢˜
3. å¢åŠ äº†è¯¦ç»†çš„æ—¥å¿—è®°å½•
4. æä¾›äº†è¯Šæ–­å’Œæµ‹è¯•å·¥å…·

ğŸ¯ **å»ºè®®ï¼š**
- **ä¼˜å…ˆä½¿ç”¨æ–°çš„ `/pbl/school/my-school/*` ç³»åˆ—API**
- é¿å…åœ¨å‰ç«¯ç¡¬ç¼–ç  school_uuid
- å¦‚æœé‡åˆ°æƒé™é—®é¢˜ï¼Œå…ˆè¿è¡Œè¯Šæ–­è„šæœ¬æ£€æŸ¥é…ç½®

---

**ä¿®å¤å®Œæˆæ—¶é—´ï¼š** 2024å¹´12æœˆ22æ—¥  
**ä¿®å¤äººï¼š** AIåŠ©æ‰‹

