# æ–‡ä»¶ä¸Šä¼ ç›®å½•æŒä¹…åŒ–é…ç½®è¯´æ˜

## ğŸ“ ä¸Šä¼ ç›®å½•è¯´æ˜

åç«¯æœåŠ¡æœ‰ä»¥ä¸‹å‡ ä¸ªéœ€è¦æŒä¹…åŒ–çš„ç›®å½•ï¼š

### 1. `/app/uploads` - èµ„æºæ–‡ä»¶ä¸Šä¼ ç›®å½•
- **ç”¨é€”**: å­˜å‚¨ PBL æ¨¡å—ä¸­ä¸Šä¼ çš„è¯¾ç¨‹èµ„æºæ–‡ä»¶ï¼ˆè§†é¢‘ã€æ–‡æ¡£ç­‰ï¼‰
- **ç›¸å…³ä»£ç **: `backend/app/api/pbl/admin_resources.py`
- **æ–‡ä»¶ç±»å‹**: 
  - è§†é¢‘: `.mp4`, `.avi`, `.mov`, `.wmv`, `.flv`
  - æ–‡æ¡£: `.pdf`, `.doc`, `.docx`, `.txt`, `.md`, `.ppt`, `.pptx`

### 2. `/app/static/firmware` - å›ºä»¶æ–‡ä»¶ä¸Šä¼ ç›®å½•
- **ç”¨é€”**: å­˜å‚¨ ESP32 è®¾å¤‡çš„å›ºä»¶ `.bin` æ–‡ä»¶
- **ç›¸å…³ä»£ç **: `backend/app/api/firmware.py`
- **æ–‡ä»¶ç±»å‹**: `.bin` (å›ºä»¶æ–‡ä»¶)

### 3. `/app/backend/data/knowledge-bases` - çŸ¥è¯†åº“æ–‡æ¡£ç›®å½•
- **ç”¨é€”**: å­˜å‚¨ AI çŸ¥è¯†åº“çš„æ–‡æ¡£æ–‡ä»¶
- **ç›¸å…³ä»£ç **: çŸ¥è¯†åº“ç›¸å…³ API
- **æ–‡ä»¶ç±»å‹**: å„ç±»æ–‡æ¡£æ–‡ä»¶

---

## ğŸ³ Docker æŒä¹…åŒ–é…ç½®

### Docker Volume å®šä¹‰

åœ¨æ‰€æœ‰ Docker Compose é…ç½®æ–‡ä»¶ä¸­ï¼Œå·²æ·»åŠ ä»¥ä¸‹ Volume å®šä¹‰ï¼š

```yaml
volumes:
  uploads_data:          # ä¸Šä¼ æ–‡ä»¶å­˜å‚¨å·
  static_data:           # é™æ€æ–‡ä»¶å­˜å‚¨å·ï¼ˆå›ºä»¶ã€èµ„æºç­‰ï¼‰
  knowledge_bases_data:  # çŸ¥è¯†åº“æ–‡æ¡£å…±äº«å­˜å‚¨å·
```

### åç«¯æœåŠ¡ Volume æŒ‚è½½

```yaml
services:
  backend:
    volumes:
      # çŸ¥è¯†åº“æ–‡æ¡£æŒä¹…åŒ–
      - knowledge_bases_data:/app/backend/data/knowledge-bases
      # èµ„æºæ–‡ä»¶ä¸Šä¼ ç›®å½•æŒä¹…åŒ–
      - uploads_data:/app/uploads
      # é™æ€æ–‡ä»¶æŒä¹…åŒ–ï¼ˆå›ºä»¶ç­‰ï¼‰
      - static_data:/app/static
```

---

## ğŸ“‹ é…ç½®æ–‡ä»¶æ¸…å•

ä»¥ä¸‹é…ç½®æ–‡ä»¶å·²å…¨éƒ¨æ›´æ–°ï¼Œæ·»åŠ äº†æ–‡ä»¶ä¸Šä¼ ç›®å½•çš„æŒä¹…åŒ–é…ç½®ï¼š

1. âœ… `docker/docker-compose.yml` - åŸºç¡€å¼€å‘ç¯å¢ƒ
2. âœ… `docker/docker-compose.prod.yml` - ç”Ÿäº§ç¯å¢ƒï¼ˆå®Œæ•´æœåŠ¡ï¼‰
3. âœ… `docker/docker-compose.external-db.yml` - ä½¿ç”¨å¤–éƒ¨æ•°æ®åº“
4. âœ… `docker/docker-compose.with-mqtt.yml` - å¸¦ MQTT æœåŠ¡çš„ç‹¬ç«‹é…ç½®

---

## ğŸ”§ Dockerfile æ”¹è¿›

### åˆ›å»ºå¿…è¦ç›®å½•

åœ¨ `backend/Dockerfile` ä¸­æ·»åŠ äº†ç›®å½•åˆ›å»ºæ­¥éª¤ï¼š

```dockerfile
# åˆ›å»ºå¿…è¦çš„ä¸Šä¼ ç›®å½•
RUN mkdir -p /app/uploads /app/static/firmware /app/backend/data/knowledge-bases && \
    chmod -R 755 /app/uploads /app/static /app/backend/data
```

è¿™ç¡®ä¿äº†ï¼š
- å®¹å™¨å¯åŠ¨æ—¶ç›®å½•å·²å­˜åœ¨
- ç›®å½•å…·æœ‰æ­£ç¡®çš„æƒé™ï¼ˆ755ï¼‰
- åº”ç”¨å¯ä»¥æ­£å¸¸å†™å…¥æ–‡ä»¶

---

## ğŸš€ éƒ¨ç½²è¯´æ˜

### é¦–æ¬¡éƒ¨ç½²

```bash
# 1. å¯åŠ¨æœåŠ¡
cd docker
docker-compose -f docker-compose.prod.yml up -d

# 2. æŸ¥çœ‹ Volume æ˜¯å¦åˆ›å»ºæˆåŠŸ
docker volume ls | grep codehubot

# é¢„æœŸè¾“å‡ºï¼š
# docker_uploads_data
# docker_static_data
# docker_knowledge_bases_data
```

### æ•°æ®è¿ç§»

å¦‚æœå·²æœ‰æ—§å®¹å™¨è¿è¡Œä¸­ï¼Œéœ€è¦è¿ç§»æ•°æ®ï¼š

```bash
# 1. åœæ­¢æ—§å®¹å™¨
docker-compose down

# 2. ä»æ—§å®¹å™¨å¤åˆ¶æ•°æ®åˆ° Volumeï¼ˆå¦‚æœéœ€è¦ï¼‰
docker run --rm -v old_container:/source -v docker_uploads_data:/target alpine sh -c "cp -r /source/* /target/"

# 3. å¯åŠ¨æ–°å®¹å™¨
docker-compose up -d
```

### æ•°æ®å¤‡ä»½

```bash
# å¤‡ä»½ä¸Šä¼ æ–‡ä»¶
docker run --rm -v docker_uploads_data:/data -v $(pwd):/backup alpine tar czf /backup/uploads-backup.tar.gz /data

# å¤‡ä»½é™æ€æ–‡ä»¶ï¼ˆå›ºä»¶ï¼‰
docker run --rm -v docker_static_data:/data -v $(pwd):/backup alpine tar czf /backup/static-backup.tar.gz /data

# å¤‡ä»½çŸ¥è¯†åº“æ–‡æ¡£
docker run --rm -v docker_knowledge_bases_data:/data -v $(pwd):/backup alpine tar czf /backup/kb-backup.tar.gz /data
```

### æ•°æ®æ¢å¤

```bash
# æ¢å¤ä¸Šä¼ æ–‡ä»¶
docker run --rm -v docker_uploads_data:/data -v $(pwd):/backup alpine sh -c "cd /data && tar xzf /backup/uploads-backup.tar.gz --strip 1"

# æ¢å¤é™æ€æ–‡ä»¶
docker run --rm -v docker_static_data:/data -v $(pwd):/backup alpine sh -c "cd /data && tar xzf /backup/static-backup.tar.gz --strip 1"

# æ¢å¤çŸ¥è¯†åº“æ–‡æ¡£
docker run --rm -v docker_knowledge_bases_data:/data -v $(pwd):/backup alpine sh -c "cd /data && tar xzf /backup/kb-backup.tar.gz --strip 1"
```

---

## ğŸ” æ•…éšœæ’æŸ¥

### æ£€æŸ¥ Volume æ˜¯å¦æ­£ç¡®æŒ‚è½½

```bash
# è¿›å…¥å®¹å™¨æŸ¥çœ‹
docker exec -it codehubot-backend bash

# æ£€æŸ¥ç›®å½•æ˜¯å¦å­˜åœ¨
ls -la /app/uploads
ls -la /app/static/firmware
ls -la /app/backend/data/knowledge-bases

# æ£€æŸ¥æƒé™
ls -ld /app/uploads /app/static /app/backend/data
```

### æ£€æŸ¥æ–‡ä»¶æ˜¯å¦æŒä¹…åŒ–

```bash
# 1. ä¸Šä¼ ä¸€ä¸ªæµ‹è¯•æ–‡ä»¶ï¼ˆé€šè¿‡ APIï¼‰

# 2. é‡å¯å®¹å™¨
docker restart codehubot-backend

# 3. æ£€æŸ¥æ–‡ä»¶æ˜¯å¦è¿˜åœ¨
docker exec -it codehubot-backend ls -la /app/uploads
docker exec -it codehubot-backend ls -la /app/static/firmware
```

### æƒé™é—®é¢˜

å¦‚æœå‡ºç°æƒé™é”™è¯¯ï¼Œæ£€æŸ¥ï¼š

```bash
# æŸ¥çœ‹å®¹å™¨å†…è¿›ç¨‹çš„ç”¨æˆ·
docker exec -it codehubot-backend ps aux

# ä¿®å¤æƒé™ï¼ˆå¦‚æœéœ€è¦ï¼‰
docker exec -it codehubot-backend chmod -R 755 /app/uploads /app/static /app/backend/data
```

---

## âš ï¸ æ³¨æ„äº‹é¡¹

1. **Volume å‘½å**: Docker Compose ä¼šè‡ªåŠ¨æ·»åŠ é¡¹ç›®åå‰ç¼€ï¼Œä¾‹å¦‚ `docker_uploads_data`
2. **æ•°æ®å®‰å…¨**: å®šæœŸå¤‡ä»½ Volume æ•°æ®ï¼Œé¿å…æ•°æ®ä¸¢å¤±
3. **ç£ç›˜ç©ºé—´**: ç›‘æ§ä¸Šä¼ æ–‡ä»¶çš„ç£ç›˜ä½¿ç”¨æƒ…å†µï¼ŒåŠæ—¶æ¸…ç†æ— ç”¨æ–‡ä»¶
4. **æƒé™ç®¡ç†**: ç¡®ä¿å®¹å™¨å†…çš„åº”ç”¨æœ‰è¶³å¤Ÿçš„æƒé™å†™å…¥è¿™äº›ç›®å½•
5. **ç¯å¢ƒå˜é‡**: å¦‚æœä¿®æ”¹äº†ç›®å½•è·¯å¾„ï¼Œéœ€è¦åœ¨ç¯å¢ƒå˜é‡ä¸­åŒæ­¥æ›´æ–°

---

## ğŸ“Š ç£ç›˜ä½¿ç”¨ç›‘æ§

```bash
# æŸ¥çœ‹æ‰€æœ‰ Volume çš„ç£ç›˜ä½¿ç”¨æƒ…å†µ
docker system df -v

# æŸ¥çœ‹ç‰¹å®š Volume çš„å¤§å°
docker run --rm -v docker_uploads_data:/data alpine du -sh /data
docker run --rm -v docker_static_data:/data alpine du -sh /data
docker run --rm -v docker_knowledge_bases_data:/data alpine du -sh /data
```

---

## ğŸ“ ç›¸å…³ä»£ç ä½ç½®

- å›ºä»¶ä¸Šä¼ : `backend/app/api/firmware.py:160-162`
- èµ„æºä¸Šä¼ : `backend/app/api/pbl/admin_resources.py:28-29`
- é™æ€æ–‡ä»¶æŒ‚è½½: `backend/main.py:199-201`
- Dockerfile: `backend/Dockerfile:39-41`

---

**æœ€åæ›´æ–°æ—¶é—´**: 2025-12-20





