# è¿œç¨‹æœåŠ¡å™¨æ›´æ–°æŒ‡å—

æœ¬æ–‡æ¡£è¯´æ˜å¦‚ä½•åœ¨è¿œç¨‹æœåŠ¡å™¨ä¸Šæ›´æ–°å·²éƒ¨ç½²çš„ CodeHubot ç³»ç»Ÿã€‚

---

## ğŸ“‹ æ›´æ–°å†…å®¹æ¦‚è¿°

æœ¬æ¬¡æ›´æ–°æ·»åŠ äº†æ–‡ä»¶ä¸Šä¼ ç›®å½•çš„ Docker Volume æŒä¹…åŒ–é…ç½®ï¼Œä¸»è¦æ”¹åŠ¨ï¼š

- âœ… æ·»åŠ  `uploads_data`ã€`static_data` Volume æŒä¹…åŒ–
- âœ… åç«¯ Dockerfile è‡ªåŠ¨åˆ›å»ºä¸Šä¼ ç›®å½•
- âœ… æ›´æ–°æ‰€æœ‰ docker-compose é…ç½®æ–‡ä»¶
- âœ… æ·»åŠ å¤‡ä»½/æ¢å¤æ–‡æ¡£

---

## ğŸš€ è¿œç¨‹æœåŠ¡å™¨æ›´æ–°æ­¥éª¤

### æ–¹æ³•ä¸€ï¼šæ»šåŠ¨æ›´æ–°ï¼ˆæ¨èï¼Œæ— éœ€åœæœºï¼‰

è¿™ç§æ–¹æ³•ä¼šå…ˆå¯åŠ¨æ–°å®¹å™¨ï¼Œå†åœæ­¢æ—§å®¹å™¨ï¼Œå®ç°å¹³æ»‘è¿‡æ¸¡ã€‚

#### 1. ç™»å½•è¿œç¨‹æœåŠ¡å™¨

```bash
ssh user@your-server-ip
```

#### 2. è¿›å…¥é¡¹ç›®ç›®å½•

```bash
cd /path/to/CodeHubot
```

#### 3. å¤‡ä»½å½“å‰ä¸Šä¼ çš„æ–‡ä»¶ï¼ˆé‡è¦ï¼ï¼‰

```bash
# åˆ›å»ºå¤‡ä»½ç›®å½•
mkdir -p ~/codehubot-backups/$(date +%Y%m%d_%H%M%S)
cd ~/codehubot-backups/$(date +%Y%m%d_%H%M%S)

# å¤‡ä»½ä¸Šä¼ æ–‡ä»¶ï¼ˆå¦‚æœæœ‰çš„è¯ï¼‰
docker cp codehubot-backend:/app/uploads ./uploads-backup 2>/dev/null || echo "æ²¡æœ‰ uploads ç›®å½•"
docker cp codehubot-backend:/app/static ./static-backup 2>/dev/null || echo "æ²¡æœ‰ static ç›®å½•"

# è¿”å›é¡¹ç›®ç›®å½•
cd /path/to/CodeHubot
```

#### 4. æ‹‰å–æœ€æ–°ä»£ç 

```bash
# æŸ¥çœ‹å½“å‰åˆ†æ”¯
git branch

# æ‹‰å–æœ€æ–°ä»£ç 
git pull origin main

# æŸ¥çœ‹æ›´æ–°å†…å®¹
git log -3 --oneline
```

#### 5. æŸ¥çœ‹ docker-compose é…ç½®å·®å¼‚

```bash
# æŸ¥çœ‹é…ç½®æ–‡ä»¶å˜åŒ–
git diff HEAD~1 docker/docker-compose.prod.yml
```

#### 6. é‡æ–°æ„å»ºå¹¶å¯åŠ¨æœåŠ¡

```bash
cd docker

# é‡æ–°æ„å»ºåç«¯é•œåƒï¼ˆå› ä¸º Dockerfile æœ‰æ›´æ–°ï¼‰
docker-compose -f docker-compose.prod.yml build backend

# æ»šåŠ¨æ›´æ–°ï¼šå¯åŠ¨æ–°å®¹å™¨ï¼Œè‡ªåŠ¨åœæ­¢æ—§å®¹å™¨
docker-compose -f docker-compose.prod.yml up -d
```

#### 7. æ¢å¤ä¹‹å‰çš„ä¸Šä¼ æ–‡ä»¶ï¼ˆå¦‚æœå¤‡ä»½äº†ï¼‰

```bash
# å¦‚æœä¹‹å‰æœ‰ä¸Šä¼ çš„æ–‡ä»¶ï¼Œéœ€è¦å¤åˆ¶åˆ°æ–°çš„ Volume ä¸­
BACKUP_DIR=~/codehubot-backups/$(ls -t ~/codehubot-backups/ | head -1)

# æ¢å¤ uploads ç›®å½•
if [ -d "$BACKUP_DIR/uploads-backup" ]; then
  docker cp "$BACKUP_DIR/uploads-backup/." codehubot-backend:/app/uploads/
  echo "âœ… uploads ç›®å½•å·²æ¢å¤"
fi

# æ¢å¤ static ç›®å½•
if [ -d "$BACKUP_DIR/static-backup" ]; then
  docker cp "$BACKUP_DIR/static-backup/." codehubot-backend:/app/static/
  echo "âœ… static ç›®å½•å·²æ¢å¤"
fi
```

#### 8. éªŒè¯æœåŠ¡çŠ¶æ€

```bash
# æŸ¥çœ‹æ‰€æœ‰æœåŠ¡çŠ¶æ€
docker-compose -f docker-compose.prod.yml ps

# æŸ¥çœ‹åç«¯æœåŠ¡æ—¥å¿—
docker-compose -f docker-compose.prod.yml logs -f backend --tail=50

# æµ‹è¯• API æ˜¯å¦æ­£å¸¸
curl http://localhost:8000/health
```

#### 9. éªŒè¯æ–‡ä»¶æŒä¹…åŒ–

```bash
# è¿›å…¥å®¹å™¨æ£€æŸ¥ç›®å½•
docker exec -it codehubot-backend bash

# åœ¨å®¹å™¨å†…æ‰§è¡Œ
ls -la /app/uploads
ls -la /app/static/firmware
ls -la /app/backend/data/knowledge-bases

# æ£€æŸ¥æƒé™
ls -ld /app/uploads /app/static /app/backend/data

# é€€å‡ºå®¹å™¨
exit
```

#### 10. éªŒè¯ Volume æ˜¯å¦åˆ›å»º

```bash
# æŸ¥çœ‹ Volume åˆ—è¡¨
docker volume ls | grep -E "uploads_data|static_data|knowledge_bases"

# é¢„æœŸè¾“å‡ºç±»ä¼¼ï¼š
# docker_uploads_data
# docker_static_data
# docker_knowledge_bases_data
```

---

### æ–¹æ³•äºŒï¼šå®Œå…¨åœæœºæ›´æ–°ï¼ˆæ•°æ®è¿ç§»åœºæ™¯ï¼‰

å¦‚æœéœ€è¦ä»æ—§çš„æ–‡ä»¶å­˜å‚¨æ–¹å¼è¿ç§»åˆ°æ–°çš„ Volume æ–¹å¼ï¼Œä½¿ç”¨æ­¤æ–¹æ³•ã€‚

#### 1-4 æ­¥åŒæ–¹æ³•ä¸€

#### 5. å¤‡ä»½æ‰€æœ‰æ•°æ®

```bash
# å¤‡ä»½æ•°æ®åº“
docker exec codehubot-mysql mysqldump -uaiot_user -p[å¯†ç ] aiot_admin > ~/codehubot-backups/db-backup-$(date +%Y%m%d_%H%M%S).sql

# å¤‡ä»½ä¸Šä¼ æ–‡ä»¶ï¼ˆå¦‚æœæ—§å®¹å™¨ä¸­æœ‰ï¼‰
docker cp codehubot-backend:/app/uploads ~/codehubot-backups/uploads-old 2>/dev/null || true
docker cp codehubot-backend:/app/static ~/codehubot-backups/static-old 2>/dev/null || true
```

#### 6. åœæ­¢å¹¶åˆ é™¤æ—§å®¹å™¨

```bash
cd docker

# åœæ­¢æ‰€æœ‰æœåŠ¡
docker-compose -f docker-compose.prod.yml down

# âš ï¸ æ³¨æ„ï¼šä¸è¦åŠ  -v å‚æ•°ï¼Œå¦åˆ™ä¼šåˆ é™¤ Volume æ•°æ®
```

#### 7. æ¸…ç†æ—§é•œåƒï¼ˆå¯é€‰ï¼‰

```bash
# åˆ é™¤æ—§çš„åç«¯é•œåƒ
docker rmi docker_backend 2>/dev/null || true
```

#### 8. é‡æ–°æ„å»ºå¹¶å¯åŠ¨

```bash
# é‡æ–°æ„å»º
docker-compose -f docker-compose.prod.yml build

# å¯åŠ¨æ‰€æœ‰æœåŠ¡
docker-compose -f docker-compose.prod.yml up -d
```

#### 9. æ¢å¤æ•°æ®

```bash
# ç­‰å¾… MySQL å¯åŠ¨å®Œæˆ
sleep 30

# æ¢å¤æ•°æ®åº“ï¼ˆå¦‚æœéœ€è¦ï¼‰
# docker exec -i codehubot-mysql mysql -uaiot_user -p[å¯†ç ] aiot_admin < ~/codehubot-backups/db-backup-xxx.sql

# æ¢å¤ä¸Šä¼ æ–‡ä»¶
if [ -d ~/codehubot-backups/uploads-old ]; then
  docker cp ~/codehubot-backups/uploads-old/. codehubot-backend:/app/uploads/
  echo "âœ… uploads ç›®å½•å·²æ¢å¤"
fi

if [ -d ~/codehubot-backups/static-old ]; then
  docker cp ~/codehubot-backups/static-old/. codehubot-backend:/app/static/
  echo "âœ… static ç›®å½•å·²æ¢å¤"
fi
```

#### 10. éªŒè¯æœåŠ¡ï¼ˆåŒæ–¹æ³•ä¸€çš„æ­¥éª¤ 8-10ï¼‰

---

## ğŸ” éªŒè¯æ–‡ä»¶æŒä¹…åŒ–æ˜¯å¦ç”Ÿæ•ˆ

### æµ‹è¯•æ­¥éª¤

```bash
# 1. é€šè¿‡ API ä¸Šä¼ ä¸€ä¸ªæµ‹è¯•æ–‡ä»¶ï¼ˆæˆ–æ‰‹åŠ¨æ”¾å…¥ï¼‰
docker exec -it codehubot-backend bash -c "echo 'test' > /app/uploads/test.txt"

# 2. é‡å¯åç«¯å®¹å™¨
docker restart codehubot-backend

# 3. ç­‰å¾…å®¹å™¨å¯åŠ¨
sleep 5

# 4. æ£€æŸ¥æ–‡ä»¶æ˜¯å¦è¿˜åœ¨
docker exec -it codehubot-backend cat /app/uploads/test.txt

# é¢„æœŸè¾“å‡ºï¼štest
```

å¦‚æœæ–‡ä»¶è¿˜åœ¨ï¼Œè¯´æ˜æŒä¹…åŒ–é…ç½®æˆåŠŸï¼âœ…

---

## ğŸ“Š ç›‘æ§å’Œç»´æŠ¤

### æŸ¥çœ‹ç£ç›˜ä½¿ç”¨

```bash
# æŸ¥çœ‹æ‰€æœ‰ Volume çš„ç£ç›˜ä½¿ç”¨
docker system df -v

# æŸ¥çœ‹ç‰¹å®š Volume çš„å¤§å°
docker run --rm -v docker_uploads_data:/data alpine du -sh /data
docker run --rm -v docker_static_data:/data alpine du -sh /data
docker run --rm -v docker_knowledge_bases_data:/data alpine du -sh /data
```

### å®šæœŸå¤‡ä»½

å»ºè®®åˆ›å»ºå®šæ—¶ä»»åŠ¡ï¼Œæ¯å¤©è‡ªåŠ¨å¤‡ä»½ï¼š

```bash
# åˆ›å»ºå¤‡ä»½è„šæœ¬
cat > /opt/codehubot-backup.sh << 'EOF'
#!/bin/bash
BACKUP_DIR="/backup/codehubot/$(date +%Y%m%d)"
mkdir -p "$BACKUP_DIR"

echo "å¼€å§‹å¤‡ä»½ - $(date)"

# å¤‡ä»½æ•°æ®åº“
docker exec codehubot-mysql mysqldump -uaiot_user -p${MYSQL_PASSWORD} aiot_admin > "$BACKUP_DIR/database.sql"

# å¤‡ä»½ Volume
docker run --rm -v docker_uploads_data:/data -v "$BACKUP_DIR":/backup alpine tar czf /backup/uploads.tar.gz /data
docker run --rm -v docker_static_data:/data -v "$BACKUP_DIR":/backup alpine tar czf /backup/static.tar.gz /data
docker run --rm -v docker_knowledge_bases_data:/data -v "$BACKUP_DIR":/backup alpine tar czf /backup/kb.tar.gz /data

# åˆ é™¤ 7 å¤©å‰çš„å¤‡ä»½
find /backup/codehubot -type d -mtime +7 -exec rm -rf {} \; 2>/dev/null

echo "å¤‡ä»½å®Œæˆ - $(date)"
EOF

chmod +x /opt/codehubot-backup.sh

# æ·»åŠ  crontabï¼ˆæ¯å¤©å‡Œæ™¨ 2 ç‚¹å¤‡ä»½ï¼‰
(crontab -l 2>/dev/null; echo "0 2 * * * /opt/codehubot-backup.sh >> /var/log/codehubot-backup.log 2>&1") | crontab -
```

---

## âš ï¸ å¸¸è§é—®é¢˜

### é—®é¢˜ 1: å®¹å™¨å¯åŠ¨åç›®å½•æƒé™é”™è¯¯

**è§£å†³æ–¹æ¡ˆ**ï¼š

```bash
docker exec -it codehubot-backend chmod -R 755 /app/uploads /app/static /app/backend/data
docker restart codehubot-backend
```

### é—®é¢˜ 2: Volume åç§°ä¸å¯¹

**æ£€æŸ¥æ–¹æ³•**ï¼š

```bash
# æŸ¥çœ‹å®é™…çš„ Volume åç§°
docker volume ls

# å¦‚æœåç§°å‰ç¼€ä¸åŒï¼Œéœ€è¦è°ƒæ•´å‘½ä»¤ä¸­çš„ Volume åç§°
# ä¾‹å¦‚ï¼šcodehubot_uploads_data è€Œä¸æ˜¯ docker_uploads_data
```

### é—®é¢˜ 3: æ—§æ–‡ä»¶ä¸¢å¤±

**è§£å†³æ–¹æ¡ˆ**ï¼š

å¦‚æœå¿˜è®°å¤‡ä»½ï¼Œå¯ä»¥å°è¯•ä»æ—§å®¹å™¨æ¢å¤ï¼š

```bash
# æŸ¥çœ‹æ‰€æœ‰å®¹å™¨ï¼ˆåŒ…æ‹¬åœæ­¢çš„ï¼‰
docker ps -a

# å¦‚æœæ—§å®¹å™¨è¿˜åœ¨ï¼Œå¯ä»¥ä»ä¸­å¤åˆ¶æ–‡ä»¶
docker cp <æ—§å®¹å™¨ID>:/app/uploads ./recovered-uploads
docker cp ./recovered-uploads/. codehubot-backend:/app/uploads/
```

### é—®é¢˜ 4: æ›´æ–°åæœåŠ¡æ— æ³•å¯åŠ¨

**æ’æŸ¥æ­¥éª¤**ï¼š

```bash
# 1. æŸ¥çœ‹æ—¥å¿—
docker-compose -f docker-compose.prod.yml logs backend --tail=100

# 2. æ£€æŸ¥é…ç½®æ–‡ä»¶
docker-compose -f docker-compose.prod.yml config

# 3. å›æ»šåˆ°ä¸Šä¸€ä¸ªç‰ˆæœ¬
git log --oneline -5
git checkout <ä¸Šä¸€ä¸ªæäº¤çš„hash>
docker-compose -f docker-compose.prod.yml up -d

# 4. æ¢å¤åˆ°æœ€æ–°ç‰ˆæœ¬
git checkout main
```

---

## ğŸ“ éœ€è¦å¸®åŠ©ï¼Ÿ

å¦‚æœé‡åˆ°é—®é¢˜ï¼Œè¯·ï¼š

1. æŸ¥çœ‹æ—¥å¿—ï¼š`docker-compose logs -f backend`
2. æ£€æŸ¥ Volumeï¼š`docker volume ls`
3. æŸ¥çœ‹å®¹å™¨çŠ¶æ€ï¼š`docker ps -a`
4. è”ç³»æŠ€æœ¯æ”¯æŒ

---

**æœ€åæ›´æ–°æ—¶é—´**: 2025-12-20

